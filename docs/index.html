<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>アイドルマスター ミリオンライブ！ シアターデイズ イベントサポート</title>
    <!-- BootstrapのCSS読み込み -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery読み込み -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- BootstrapのJS読み込み -->
    <script src="js/bootstrap.bundle.min.js"></script>
    <style type="text/css">
        label {
            margin-top: 1em;
        }

        button {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 2.5 rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ミリシタイベントサポートツール</h1>
        <p>目標とするイベントポイントを獲得するため、イベント期間中に必要な残り楽曲プレイ回数や大まかな所要時間を知ることができます。</p>
        <div id="errorArea">
        </div>
        <label for="currentPoint">現在の獲得ポイント</label>
        <input type="number" name="currentPoint" class="form-control" id="currentPoint" placeholder="現在の獲得ポイント" min="0" max="5000000">
        <label for="goalPoint">目標ポイント</label>
        <input type="number" name="goalPoint" class="form-control" id="goalPoint" placeholder="目標ポイント" min="0" max="5000000">
        <label for="healthy">元気の上限値</label>
        <input type="number" name="healthy" class="form-control" id="healthy" placeholder="元気の上限値" min="0" max="300">
        <div class="text-center">
            <button type="submit" class="btn btn-primary col-md-6" id="sample" onclick="get();">Enter</button>
        </div>
        <p>あと
            <span id="normalPlayCount">x</span>回 通常楽曲をプレイする必要があります。</p>
        <p>あと
            <span id="eventPlayCount">x</span>回 イベント楽曲をプレイする必要があります。</p>
        <p>あと
            <span id="jewel">x</span>回 石を割る必要があります。</p>
        <p>所要時間: およそ
            <span id="time">xx時間xx分xx秒</span>
        </p>
        <a class="btn btn-primary" id="tweet" href="#" role="button">Tweet</a>
        <p>※楽曲時間は、Sentimental Venus およそ113秒 を目安にプレイ時間を計測しています。</p>
        <p>※個人の感想であり使用者全員が記載の時間内で終わることを保証するものではありません。</p>
    </div>

    <script>


        function getCount(q, r) {
            let count = 0;
            r == 0 ? count = q : count = q + 1;
            return count;
        }

        function toHms(t) {
            let hms = "";
            let h = t / 3600 | 0;
            let m = t % 3600 / 60 | 0;
            let s = t % 60;
            if (h != 0) {
                hms = h + "時間" + padZero(m) + "分" + padZero(s) + "秒";
            } else if (m != 0) {
                hms = m + "分" + padZero(s) + "秒";
            } else {
                hms = s + "秒";
            }
            return hms;

            function padZero(v) {
                if (v < 10) {
                    return "0" + v;
                } else {
                    return v;
                }
            }
        }
        function addError(str) {
            const preTag = '<div class="alert alert-warning" role="alert">';
            const postTag = '</div>';
            let element = document.getElementById("errorArea");
            element.innerHTML = element.innerHTML + preTag + str + postTag;
        }

        function clearError() {
            let element = document.getElementById("errorArea");
            element.innerHTML = "";
        }

        function validate(value, max, min, name) {
            if (isNaN(value) || value === "") {
                addError(name + " を入力してください。");
                return false;
            }
            else if (value > max) {
                if (name == "元気の上限値"){
                    addError(name + "は上限値(300)以下にしてください。");
                }else{
                    addError(name + "は上限値(5000000)以下にしてください。");
                }
                return false;
            }
            else if (value < min) {
                addError(name + "は 0以上にしてください。");
                return false;
            }
            return true;
        }
        let eventPlayCount = 0;
        let eventPoint = 0;
        let jewel = 0;
        let time = 0;

        function get() {
            let currentPoint = document.querySelector("#currentPoint").value;
            let goalPoint = document.querySelector("#goalPoint").value;
            let healthy = document.querySelector("#healthy").value;

            clearError();
            let isCurrentPointValid = validate(currentPoint, 500000, 0, "現在の獲得ポイント");
            let isGoalPointValid = validate(goalPoint, 500000, 0, "目標ポイント");
            let isHealthyValid = validate(healthy, 300, 1, "元気の上限値");

            if (isCurrentPointValid && isGoalPointValid && isHealthyValid) {
                const onePlay = 68;
                const eventPlayCost = 180;
                const eventPlay = 429;
                let normalPlayCount = 0;
                eventPlayCount = 0;
                eventPoint = 0;
                jewel = 0;

                let remainingPoint = goalPoint - currentPoint + '';
                while (remainingPoint > 0) {
                    eventPoint += onePlay;
                    remainingPoint -= onePlay;
                    if (eventPoint >= eventPlayCost) {
                        eventPoint -= eventPlayCost;
                        remainingPoint -= eventPlay;
                        eventPlayCount += 1;
                    }
                    normalPlayCount += 1;
                }
                let label = document.querySelector("#normalPlayCount");
                label.innerHTML = normalPlayCount + '';
                let q = Math.floor(eventPlayCount / 4);
                let r = eventPlayCount % 4;
                eventPlayCount = getCount(q, r);
                let label2 = document.querySelector("#eventPlayCount");
                label2.innerHTML = eventPlayCount + '';
                q = Math.floor((normalPlayCount * 30) / healthy);
                r = (normalPlayCount * 30) % healthy;
                jewel = getCount(q, r);
                let label3 = document.querySelector("#jewel");
                label3.innerHTML = jewel + '';
                let sec = normalPlayCount * 113;
                let label4 = document.querySelector("#time");
                time = toHms(sec);
                label4.innerHTML = time + '';
                var text = "イベント 目標ポイントまで 残り\n" + "通常楽曲: " + normalPlayCount + '' + "回\n" + "イベント楽曲: " + eventPlayCount + '' + "回\n" + jewel + '' + "回 ジュエルを使用\n" + "所要時間: およそ" + toHms(sec) + '' + "\nhttps://golasa72.github.io/theaterdaysEventSupportTool/\n#ミリシタ";
                let element = document.querySelector("#tweet");
                element.setAttribute('href', "https://twitter.com/intent/tweet?text=" + encodeURIComponent(text));

            }
        }
    </script>
</body>

</html>